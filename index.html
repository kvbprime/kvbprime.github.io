<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>load page</title>
  <script type="text/javascript"
    src="https://dss0.bdstatic.com/5aV1bjqh_Q23odCf/static/superman/js/lib/jquery-1-edb203c114.10.2.js"></script>
  <style>
    .show-page {
      display: flex;
    }

    .hide-page {
      display: none;
    }

    html,
    body {
      height: 100%;
      margin: 0;
    }

    .load-box {
      position: absolute;
      top: 45%;
      left: 50%;
      transform: translate(-50%, -50%);
    }

    div#load-progress {
      margin: 40px 0 20px 0;
      height: 4px;
      background: #ccc;
      border-radius: 2px;
      width: 400px;
    }

    div#load-text {
      text-align: center;
    }

    svg.logo {
      margin: auto;
      /* width: 274px; */
      display: block;
    }

    div#load-progress-content {
      background: #0c1e3d;
      height: 100%;
      transition: all 0.5s;
    }

    #load-failed {
      display: none;
      text-align: center;
      font-size: 14px;
    }

    .load-failed #load-progress-content {
      background: red;
    }

    .load-failed #load-failed {
      display: block;
    }

    .load-failed #load-text {
      display: none;
    }
  </style>
</head>

<body>
  <div class="load-box" id="load-box">
    <svg class="logo" xmlns="http://www.w3.org/2000/svg" width="274" height="60" viewBox="0 0 274 60">
      <path
        d="M127.626 42.412v-.856c1.168 0 1.713-.31 1.713-.856V19.222c0-.545-.623-.856-1.713-.856v-.856h16.654c3.035 0 5.37.544 7.16 1.712 1.712 1.09 2.568 3.035 2.568 5.68 0 2.647-.856 4.592-2.568 5.682-1.712 1.09-4.125 1.712-7.16 1.712h-9.494V40.7c0 .545.467.856 1.479.856v.856h-8.639zm17.199-14.474c1.012 0 1.945-.234 2.646-.623.7-.389 1.09-1.245 1.09-2.412 0-1.168-.39-2.024-1.09-2.413a5.77 5.77 0 0 0-2.646-.622h-10.039v6.07h10.039zm30.661-10.35c1.479 0 2.88.155 4.125.389 1.245.233 2.257.7 3.19 1.245a5.676 5.676 0 0 1 2.024 2.257c.467.933.7 2.1.7 3.424 0 2.1-.622 3.657-1.867 4.747-1.246 1.09-2.88 1.868-4.981 2.257l6.304 8.949c.233.311.466.467.778.545.311.078.545.078.856.078v.856h-8.872v-.856c.311 0 .545-.078.7-.156.234-.078.312-.234.312-.39 0-.155-.078-.31-.156-.544-.155-.233-.311-.467-.545-.856l-5.214-7.393h-6.77v8.405c0 .311.078.467.311.622.234.156.545.234 1.09.234v.856H159.3V41.4c.933 0 1.4-.312 1.4-.856V19.066c0-.545-.467-.856-1.4-.856v-.856h16.186v.234zm-1.245 11.05c1.168 0 2.101-.078 2.802-.233.778-.156 1.323-.39 1.79-.7.467-.312.778-.701.934-1.09.155-.39.31-.856.31-1.401 0-.467-.077-.934-.31-1.4-.156-.39-.467-.779-.934-1.09-.467-.312-1.012-.545-1.79-.7-.778-.156-1.712-.234-2.802-.234h-8.171v7.004h8.171v-.156zm19.378 12.918c.856 0 1.245-.31 1.245-.856V19.222c0-.545-.39-.856-1.245-.856v-.856h7.86v.856c-.856 0-1.246.311-1.246.856V40.7c0 .545.39.856 1.246.856v.856h-7.86v-.856zm15.953 0c.233 0 .467-.077.7-.233.156-.156.312-.39.312-.623V19.144c0-.311-.078-.467-.312-.623a1.554 1.554 0 0 0-.7-.155v-.856h8.872v.856c-.156 0-.312.078-.467.155a.428.428 0 0 0-.234.39c0 .155.078.389.156.622.155.234.233.545.389.778l6.77 12.296 6.77-12.14c.234-.39.39-.7.468-.934.078-.233.155-.467.155-.622 0-.312-.233-.545-.622-.545v-.856h8.716v.856c-.234 0-.467.078-.623.155-.155.078-.311.312-.311.623V40.7c0 .312.078.467.311.623.156.156.39.233.623.233v.856h-7.393v-.856c.856 0 1.245-.31 1.245-.856V24.98h-.078l-9.494 17.432h-.156l-9.338-17.431h-.078V40.7c0 .544.467.855 1.323.855v.856h-7.082l.078-.856zm62.646-18.91c0-.311-.156-.623-.39-.778-.233-.156-.7-.234-1.4-.234h-15.33v5.837h9.26c.623 0 1.09-.078 1.479-.234.31-.155.544-.622.544-1.323h.856v7.393h-.856c0-.7-.155-1.167-.544-1.4-.312-.234-.856-.312-1.479-.312h-9.26v6.537h15.797c.467 0 .856-.078 1.167-.311a1.11 1.11 0 0 0 .467-.934h.856v6.46h-.856c0-.468-.155-.779-.467-.779-.311-.078-.7-.078-1.167-.078h-22.023v-.856c.233 0 .389-.078.622-.233a.884.884 0 0 0 .234-.623V19.3c0-.312-.078-.467-.234-.623a.884.884 0 0 0-.622-.233v-.856h21.556c.7 0 1.09-.078 1.4-.312.234-.233.39-.467.39-.856h.856v6.226h-.856zM6.38 40.7c0 .312.078.467.312.623.155.156.389.233.7.233v.856H0v-.856c.7 0 1.012-.31 1.012-.856V19.222c0-.545-.312-.856-1.012-.856v-.856h7.393v.856c-.233 0-.467.078-.7.233-.156.156-.312.39-.312.623v8.95l9.806-7.705c.467-.39.778-.7 1.011-.934.234-.233.39-.467.39-.622 0-.234-.078-.39-.234-.467-.156-.078-.311-.156-.467-.156v-.856h9.961v.856c-.544 0-1.167.233-1.712.7l-10.895 8.638 9.961 11.518c.39.467.856.934 1.479 1.4.623.468 1.09.779 1.634.935v.856h-8.794v-.856c.39 0 .623-.078.623-.312 0-.155-.233-.467-.7-1.011l-8.094-9.339-3.969 3.035V40.7zm52.14-22.256c-.622 0-1.09.233-1.4.7-.312.467-.467.856-.623 1.09l-8.405 18.365c-.31.623-.544 1.168-.7 1.479-.156.389-.311.622-.311.778 0 .156.078.311.155.39l.312.31v.856H40.31v-.856c.312-.155.39-.31.39-.622 0-.156-.156-.467-.39-.934-.233-.467-.544-1.09-.856-1.79l-8.482-18.443c-.156-.312-.39-.623-.7-.779a7.097 7.097 0 0 0-1.246-.467v-.856h8.483v.856c-.234 0-.467.078-.623.156-.233.078-.311.311-.311.623 0 .31.156.778.389 1.323.233.544.623 1.167.934 2.023l6.07 12.996 5.914-12.84c.39-.856.7-1.557 1.09-2.18.311-.622.467-1.089.467-1.322 0-.467-.467-.779-1.323-.779v-.856h8.249v.779h.155zm49.417-.856L94.63 60h-8.793l13.307-42.412h8.794zm-31.985 0c1.479 0 2.88.155 4.203.389 1.323.233 2.568.622 3.58 1.167 1.011.545 1.867 1.167 2.49 2.023.622.856.934 1.868.934 3.113 0 1.479-.467 2.646-1.401 3.424-.934.778-2.024 1.401-3.269 1.868v.078c1.479.467 2.724 1.167 3.736 2.101 1.011.934 1.556 2.335 1.556 4.124 0 .934-.233 1.79-.622 2.646-.39.779-1.012 1.479-1.79 2.102-.779.622-1.79 1.09-2.958 1.4-1.167.312-2.49.467-3.968.467H61.089v-.856c.857 0 1.323-.311 1.323-.856V19.3c0-.545-.466-.856-1.323-.856v-.856h14.864zM127.55 0l-13.386 42.412h-8.793L118.677 0h8.872zM76.965 31.362h-9.027v6.692h9.027c2.023 0 3.424-.31 4.28-.933.856-.623 1.323-1.401 1.323-2.413 0-1.012-.467-1.79-1.323-2.412-.856-.623-2.257-.934-4.28-.934zm0-9.65h-9.027v5.681h9.027v-.078c1.4 0 2.568-.155 3.502-.545.934-.389 1.4-1.09 1.4-2.256 0-1.168-.466-1.946-1.4-2.257-.934-.39-2.101-.545-3.502-.545z"
        fill="#0C1E3D" fill-rule="nonzero" />
    </svg>
    <div id="load-progress" class="load-progress">
      <div id="load-progress-content"></div>
    </div>
    <div id="load-text">Loading...</div>
    <div id="load-failed">
      加载失败，请联系<a target="_blank"
        href="https://secure.livechatinc.com/customer/action/open_chat?license_id=10511302">在线客服</a>
    </div>
  </div>

  <!-- get ip -->
  <!-- <script src="http://pv.sohu.com/cityjson?ie=utf-8"></script>   -->

  <!-- log -->
  <script type="text/javascript" src="https://www.datadoghq-browser-agent.com/us1/v4/datadog-logs.js"></script>
  <!-- domain -->
  <script>
    var useIP = "";

    window.DD_LOGS &&
      window.DD_LOGS.init({
        clientToken: 'pub79a88931937020a559d72074868b090f',
        site: 'datadoghq.com',
        forwardErrorsToLogs: false,
        sessionSampleRate: 100,
      })

    /** 
     * 获取ip
     */
    $.ajax({
      url: 'https://ipapi.co/json/',
      success: (res) => {
        useIP = res.ip;
      }
    })

    // url 验证
    function urlCheck(domain, success, error) {
      // return setTimeout(error, Math.random() * 10000);
      $.ajax({
        url: domain,
        success() {
          success(domain);
        },
        error() {
          error(domain);
        },
        cache() {
          error(domain);
        },
      });
    }

    /**
     * 匹配项目域名
     */
    function getAddressByDomain(element) {
      if (!element) return;

      // 判断是不是去邀请
      if (/invite/.test(location.search)) {
        var childName = "//portal.";
        if (/\/regs\//.test(location.search)) {
          childName = "//partner.";
        }
        return (
          childName + // portal.
          element.substring(2) + // portal.xxx.com
          location.search
            .substring(1)
            .replace(/invite=(.+?)/, function (str, $1) {
              return $1;
            })
        ); // portal.xxx.com/xxx
      }

      if (/partner/.test(location.search)) {
        return (
          "//partner." + // partner.
          element.substring(2)
        ); // partner.xxx.com
      }

      if (/portal/.test(location.search)) {
        return (
          "//portal." + // portal.
          element.substring(2)
        ); // portal.xxx.com
      }

      // 判断是否去活动
      if (/event/.test(location.search)) {
        var childName = "//event.";

        return (
          childName + // event.
          element.substring(2) + // event.xxx.com
          location.search
            .substring(1)
            .replace(/event=(.+?)/, function (str, $1) {
              return $1;
            })
        ); // portal.xxx.com/xxx
      }

      // 默认去官网
      return element; // + "/zh-cn/?to=yes";
    }

    function getIPAddressByDomain(element) {
      if (!element) return;

      // 判断是不是去邀请
      if (/invite/.test(location.search)) {
        var port = webIpPort.portal;
        if (/\/regs\//.test(location.search)) {
          port = webIpPort.partner;
        }
        return (
          element + // portal.
          ':' +
          port
        ); // 112.22.33.44:port
      }

      if (/partner/.test(location.search)) {
        var port = webIpPort.partner;
        return (
          element + // portal.
          ':' +
          port
        );
      }

      if (/portal/.test(location.search)) {
        var port = webIpPort.portal;
        return (
          element + // portal.
          ':' +
          port
        );
      }

      // 默认去官网
      return element + ':' + webIpPort.home; // + "/zh-cn/?to=yes";
    }
  </script>

  <script>

    function loadScript() {
      var progress = document.getElementById("load-progress-content");
      var success = false;
      // 需要验证的域名总数
      var totalUrlCount = webDomainList.length + apiDomainList.length;// + webIpList.length + apiIpList.length;
      var isCheckNum = 0;

      /** 可用的web domain */
      var webAvailable = [];
      /** 可用的api domain */
      var apiAvailable = [];
      /** 可用的web ip */
      var webIPAvailable = [];
      /** 可用的api ip */
      var apiIPAvailable = [];

      /** 无效的web domain */
      var webInvalid = [];
      /** 无效的api domain */
      var apiInvalid = [];
      /** 无效的web ip */
      var webIPInvalid = [];
      /** 无效的api ip */
      var apiIPInvalid = [];


      function main() {
        // 先验证前端域名
        webDomainCheck();

        // api域名校验
        apiDomainCheck();
      }

      /** 前端域名校验 */
      function webDomainCheck() {
        var webDomainSuccess = 0;
        var webDoaminFail = 0;
        webDomainList.forEach(function (element) {
          var domain = getAddressByDomain(element);
          urlCheck(
            domain,
            function (url) {
              /** 可用直接跳转 */
              // progressControl(true);
              // return location.href = getAddressByDomain(domain);

              webDomainSuccess++;
              isCheckNum++;
              webAvailable.push(url);
              complete();
            },
            function (url) {
              webDoaminFail++;
              isCheckNum++;
              webInvalid.push(url);

              // 如果 web域名全部失效，继续判断ip
              if (webDomainList.length === webInvalid.length) {
                totalUrlCount += webIpList.length;
                webIPCheck();
              }

              complete();
            }
          );
        });
      }

      /** api域名校验 */
      function apiDomainCheck() {
        var apiDomainSuccess = 0;
        var apiDoaminFail = 0;
        apiDomainList.forEach((url) => {
          const apiDomain = url.replace('//', '//api.');
          urlCheck(
            apiDomain + '/health',
            function (url) {
              isCheckNum++;

              apiDomainSuccess++;
              apiAvailable.push(apiDomain);

              complete();
            },
            function (url) {
              isCheckNum++;

              apiDoaminFail++;
              apiInvalid.push(apiDomain);

              // 如果 web域名全部失效，继续判断ip
              if (apiDomainList.length === apiInvalid.length) {
                totalUrlCount += apiIpList.length;
                apiIPCheck();
              }

              complete();
            }
          )
        });
      }

      // web ip校验
      function webIPCheck() {
        webIpList.forEach(function (ipAddress) {
          const adress = getIPAddressByDomain(ipAddress);
          urlCheck(
            adress,
            function (url) {
              isCheckNum++;
              webIPAvailable.push(url);

              complete();
            },
            function (url) {
              isCheckNum++;
              webIPInvalid.push(url);

              complete();
            }
          );
        });
      }

      function apiIPCheck() {
        apiIpList.forEach((ipAddress) => {
          const apiIp = ipAddress + ':' + webIpPort.mainApi;
          urlCheck(
            apiIp + '/health',
            function (url) {
              isCheckNum++;
              apiIPAvailable.push(apiIp);
              complete();
            },
            function (url) {
              isCheckNum++;
              apiIPInvalid.push(apiIp);
              complete();
            }
          )
        });
      }

      // 进度条样式控制
      function progressControl(complete) {
        progress.style = complete ? "width: 100%" :
          "width:" + (isCheckNum / totalUrlCount) * 100 + "%";
      }

      /**
       * 对每一次请求结果进行校验
       * 判断是否全部完成
       */
      function complete() {
        if ([webAvailable, webIPAvailable].flat()[0] && [apiAvailable, apiIPAvailable].flat()[0] ) {
          progressControl(true);
          return location.href = urlParams();
        }

        progressControl();

        /** 
         * 如果前端域名+ip全部失效；
        */
        if (webDomainList.length === webInvalid.length || webIpList.length === webIPInvalid.length) {
          finallyErrorHandle();
          errorHandle('domain-error', [webInvalid, webIPInvalid].flat());
          return;
        }

        /** 
         * 如果api域名+ip全部失效；
        */
        if (apiDomainList.length === apiInvalid.length || apiIpList.length === apiIPInvalid.length) {
          finallyErrorHandle();
          errorHandle('domain-api-error', [apiInvalid, apiIPInvalid].flat());
          return;
        }

        /** 判断是否全部验证完毕 */
        if (totalUrlCount === isCheckNum) {
          console.log("可用的 web 域名：", webAvailable);

          console.log("可用的 api 域名：", apiAvailable);

          console.log("可用的 web ip：", webIPAvailable);

          console.log("可用的 api ip：", apiIPAvailable);

          console.log("--------------------------------");

          console.log("不可用的 web 域名：", webInvalid);

          console.log("不可用的 api 域名：", apiInvalid);

          console.log("不可用的 web ip：", webIPInvalid);

          console.log("不可用的 api ip：", apiIPInvalid);

          progressControl(true);

          errorHandle('domain-error', [webInvalid, webIPInvalid].flat());
          errorHandle('domain-api-error', [apiInvalid, apiIPInvalid].flat());

          location.href = urlParams();
        }
      }

      /**
       * 收集错误
       */
      function errorHandle(type, data) {
        window.DD_LOGS.logger.error(type, {
          domain: JSON.stringify(data),
          ip: useIP,
          project: 'domain',
          type: 'domain',
          // env: 'production',
          host: location.host
        });
      }

      /**
       * url 拼接
      */
      function urlParams() {
        var webUrl = webAvailable[0] || webIPAvailable[0];
        var apiUrl = apiAvailable[0] || apiIPAvailable[0];

        if (webUrl.indexOf('?') !== -1) {
          return webUrl + '&apiUrl=' + apiUrl;
        }
        return webUrl + '?apiUrl=' + apiUrl;
      }

      /**
      * 无法访问的页面状态处理
      */
      function finallyErrorHandle() {
        $("#load-box").addClass("load-failed");
        // 加载客服
        window.__lc = window.__lc || {};
        window.__lc.license = 10511302;
        (function () {
          var lc = document.createElement("script");
          lc.type = "text/javascript";
          lc.async = true;
          lc.src =
            ("https:" == document.location.protocol
              ? "https://"
              : "http://") + "cdn.livechatinc.com/tracking.js";
          var s = document.body;
          s.parentNode.insertBefore(lc, s);
        })();
      }

      var loadText = document.getElementById("load-text");
      var animateStarTime = new Date().getTime();
      function animate() {
        // Update animation state or perform any other operations
        var nowTime = new Date().getTime();
        var dit = ~~(((nowTime - animateStarTime) / 1000) % 6);
        var text = loadText.innerText;
        var newText =
          "Loading" +
          Array(dit + 1)
            .fill(".")
            .join("");
        if (newText !== text) {
          loadText.innerText = newText;
        }
        if (totalUrlCount.length > isCheckNum) {
          requestAnimationFrame(animate);
        }
      }
      // Start the animation
      requestAnimationFrame(animate);

      main()
    }

    $.ajax('./info.json', {
      success: function (res) {
        window.webDomainList = res.webDomainList;
        window.apiDomainList = res.webDomainList;

        window.webIpList = res.webIpList;
        window.apiIpList = res.webIpList;

        window.webIpPort = res.webIpPort;

        loadScript()
      }
    })
  </script>
</body>

</html>